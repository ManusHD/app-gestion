<div class="facturacion-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>receipt</mat-icon>
        Cálculo de Facturación
      </mat-card-title>
      <mat-card-subtitle>
        Calcule la facturación mensual basada en almacenaje y movimientos
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="facturacionForm" (ngSubmit)="calcularFacturacion()">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Mes a Facturar</mat-label>
            <input matInput type="month" formControlName="mesSeleccionado" required>
            <mat-icon matSuffix>calendar_month</mat-icon>
            <mat-error *ngIf="facturacionForm.get('mesSeleccionado')?.hasError('required')">
              El mes es obligatorio
            </mat-error>
          </mat-form-field>
        </div>

        <!-- <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput type="date" formControlName="fechaInicio" required>
            <mat-icon matSuffix>date_range</mat-icon>
            <mat-error *ngIf="facturacionForm.get('fechaInicio')?.hasError('required')">
              La fecha de inicio es obligatoria
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha Fin</mat-label>
            <input matInput type="date" formControlName="fechaFin" required>
            <mat-icon matSuffix>date_range</mat-icon>
            <mat-error *ngIf="facturacionForm.get('fechaFin')?.hasError('required')">
              La fecha de fin es obligatoria
            </mat-error>
          </mat-form-field>
        </div> -->

        <div class="actions-row">
          <button mat-raised-button color="primary" type="submit" [disabled]="facturacionForm.invalid || cargando">
            <mat-icon>calculate</mat-icon>
            {{ cargando ? 'Calculando...' : 'Calcular Facturación' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Indicador de carga -->
  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Procesando datos de facturación...</p>
  </div>

  <!-- Resultados de facturación -->
  <div *ngIf="mostrarResultados && resumenFacturacion && !cargando" class="resultados-container">

    <!-- Resumen de totales -->
    <mat-card class="resumen-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>summary</mat-icon>
          Detalle de Facturación de almacenaje
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="resumen-grid">
          <div class="resumen-item almacenaje">
            <mat-icon>warehouse</mat-icon>
            <div class="resumen-content">
              <span class="label">Total Almacenaje</span>
              <span class="amount">{{ resumenFacturacion.totalAlmacenaje | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>

          <div class="resumen-item movimientos">
            <mat-icon>local_shipping</mat-icon>
            <div class="resumen-content">
              <span class="label">Total Movimientos</span>
              <span class="amount">{{ resumenFacturacion.totalMovimientos | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>

          <!-- Total Trabajos -->
          <div class="resumen-item trabajos">
            <mat-icon>build</mat-icon>
            <div class="resumen-content">
              <span class="label">Total Trabajos</span>
              <span class="amount">{{ resumenFacturacion.totalTrabajos | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>

          <div class="resumen-item total">
            <mat-icon>euro</mat-icon>
            <div class="resumen-content">
              <span class="label">Total General</span>
              <span class="amount total-amount">{{ resumenFacturacion.totalGeneral | currency:'EUR':'symbol':'1.2-2'
                }}</span>
            </div>
          </div>
        </div>

        <div class="export-actions">
          <button mat-raised-button color="primary" (click)="exportarPDF()">
            <mat-icon>picture_as_pdf</mat-icon>
            Exportar PDF
          </button>

          <button mat-stroked-button color="accent" (click)="exportarExcel()">
            <mat-icon>table_chart</mat-icon>
            Exportar Excel
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="movimientos-card" *ngIf="mostrarResultados && resumenFacturacion">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>analytics</mat-icon>
          Desglose de Movimientos del Mes
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <!-- Resumen de movimientos -->

        <!-- Facturación de ENTRADAS -->
        <div class="facturacion-seccion">
            <h5>
              <mat-icon>input</mat-icon>
              Movimientos de Entrada
            </h5>
            <div class="facturacion-tipos-grid">
              <div class="tipo-facturacion"
                *ngIf="resumenFacturacion.resumenMovimientos.facturacionEntradas.paletsCobrados > 0">
                <mat-icon class="icon-palet">inventory_2</mat-icon>
                <div class="tipo-info">
                  <span class="tipo-cantidad">{{
                    resumenFacturacion.resumenMovimientos.facturacionEntradas.paletsCobrados }} palets</span>
                  <span class="tipo-importe">{{ resumenFacturacion.resumenMovimientos.facturacionEntradas.paletsImporte
                    | currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
              </div>
              <div class="tipo-facturacion"
                *ngIf="resumenFacturacion.resumenMovimientos.facturacionEntradas.bultosCobrados > 0">
                <mat-icon class="icon-bulto">cases</mat-icon>
                <div class="tipo-info">
                  <span class="tipo-cantidad">{{
                    resumenFacturacion.resumenMovimientos.facturacionEntradas.bultosCobrados }} bultos</span>
                  <span class="tipo-importe">{{ resumenFacturacion.resumenMovimientos.facturacionEntradas.bultosImporte
                    | currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
              </div>
              <div class="tipo-facturacion"
                *ngIf="resumenFacturacion.resumenMovimientos.facturacionEntradas.unidadesCobradas > 0">
                <mat-icon class="icon-unidad">confirmation_number</mat-icon>
                <div class="tipo-info">
                  <span class="tipo-cantidad">{{
                    resumenFacturacion.resumenMovimientos.facturacionEntradas.unidadesCobradas | number }}
                    unidades</span>
                  <span class="tipo-importe">{{
                    resumenFacturacion.resumenMovimientos.facturacionEntradas.unidadesImporte |
                    currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
              </div>
            </div>
            <div class="subtotal-entradas" *ngIf="getTotalEntradas() > 0">
              <strong>Subtotal Entradas: {{ getTotalEntradas() | currency:'EUR':'symbol':'1.2-2' }}</strong>
            </div>
          </div>

        <!-- Facturación de SALIDAS -->
        <div class="facturacion-seccion">
            <h5>
              <mat-icon>output</mat-icon>
              Movimientos de Salida
            </h5>
            <div class="facturacion-tipos-grid">
              <div class="tipo-facturacion"
                *ngIf="resumenFacturacion.resumenMovimientos.facturacionSalidas.paletsCobrados > 0">
                <mat-icon class="icon-palet">inventory_2</mat-icon>
                <div class="tipo-info">
                  <span class="tipo-cantidad">{{ resumenFacturacion.resumenMovimientos.facturacionSalidas.paletsCobrados
                    }} palets</span>
                  <span class="tipo-importe">{{ resumenFacturacion.resumenMovimientos.facturacionSalidas.paletsImporte |
                    currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
              </div>
              <div class="info-no-cobrado"
                *ngIf="resumenFacturacion.resumenMovimientos.bultosSalidos > 0 || resumenFacturacion.resumenMovimientos.unidadesSalidas > 0">
                <mat-icon>info</mat-icon>
                <span>En salidas solo se facturan palets</span>
              </div>
            </div>
            <div class="subtotal-salidas" *ngIf="getTotalSalidas() > 0">
              <strong>Subtotal Salidas: {{ getTotalSalidas() | currency:'EUR':'symbol':'1.2-2' }}</strong>
            </div>
          </div>

          <div class="total-movimientos-desglose">
            <strong>Total Movimientos: {{ resumenFacturacion.totalMovimientos | currency:'EUR':'symbol':'1.2-2'
              }}</strong>
          </div>
      </mat-card-content>
    </mat-card>

    <!-- Desglose de Almacenaje de Palets -->
    <mat-card class="almacenaje-card" *ngIf="mostrarResultados && resumenFacturacion">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>warehouse</mat-icon>
          Desglose de Almacenaje de Palets
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <!-- Stock inicial vs final -->
        <div class="stock-resumen">
          <div class="stock-item inicial">
            <mat-icon>inventory</mat-icon>
            <div class="stock-info">
              <span class="label">Stock Inicial</span>
              <span class="cantidad">{{ resumenFacturacion.resumenMovimientos.stockInicialPalets }}</span>
            </div>
          </div>

          <div class="stock-item final">
            <mat-icon>inventory_2</mat-icon>
            <div class="stock-info">
              <span class="label">Stock Final</span>
              <span class="cantidad">{{ getStockFinalPalets() }}</span>
            </div>
          </div>
        </div>

        <!-- Desglose detallado de almacenaje -->
        <div class="almacenaje-desglose">
          <h4>
            <mat-icon>analytics</mat-icon>
            Desglose de Facturación de Almacenaje
          </h4>

          <!-- Palets que ya estaban al inicio del mes -->
          <div class="almacenaje-seccion stock-inicial" *ngIf="getAlmacenajeStockInicial() > 0">
            <h5>
              <mat-icon>schedule</mat-icon>
              Stock Inicial (Mes Completo)
            </h5>
            <div class="almacenaje-detalle">
              <div class="detalle-item">
                <span class="etiqueta">Palets facturados mes completo:</span>
                <span class="valor">{{ resumenFacturacion.resumenMovimientos.stockInicialPalets }}</span>
              </div>
              <div class="detalle-item importe">
                <span class="etiqueta">Importe stock inicial:</span>
                <span class="valor cobrado">{{ getAlmacenajeStockInicial() | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
            </div>
          </div>

          <!-- Palets que entraron durante el mes -->
          <div class="almacenaje-seccion entradas-mes" *ngIf="getAlmacenajeEntradas() > 0">
            <h5>
              <mat-icon>input</mat-icon>
              Entrada de Palets en el Mes (Proporcional)
            </h5>
            <div class="almacenaje-detalle">
              <div class="detalle-item">
                <span class="etiqueta">Cantidad</span>
                <span class="valor positivo">{{ resumenFacturacion.resumenMovimientos.paletsEntrados }}</span>
              </div>
              <div class="detalle-item importe">
                <span class="etiqueta">Importe proporcional:</span>
                <span class="valor cobrado">{{ getAlmacenajeEntradas() | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
            </div>
          </div>

          <!-- Palets que salieron durante el mes (descuentos) -->
          <div class="almacenaje-seccion salidas-mes" *ngIf="getAlmacenajeSalidas() < 0">
            <h5>
              <mat-icon>output</mat-icon>
              Salidas de Palets en el Mes (Descuento)
            </h5>
            <div class="almacenaje-detalle">
              <div class="detalle-item">
                <span class="etiqueta">Cantidad</span>
                <span class="valor negativo">{{ resumenFacturacion.resumenMovimientos.paletsSalidos }}</span>
              </div>
              <div class="detalle-item importe descuento">
                <span class="etiqueta">Descuento aplicado:</span>
                <span class="valor descuento-valor">{{ getAlmacenajeSalidas() | currency:'EUR':'symbol':'1.2-2'
                  }}</span>
              </div>
            </div>
          </div>

          <!-- Total de almacenaje -->
          <div class="total-almacenaje">
            <div class="total-item">
              <span class="etiqueta-total">Total Almacenaje:</span>
              <span class="valor-total">{{ resumenFacturacion.totalAlmacenaje | currency:'EUR':'symbol':'1.2-2'
                }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Tabla de detalles -->
    <mat-card class="detalles-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list_alt</mat-icon>
          Detalle de Facturación
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="resumenFacturacion.detalles" class="facturacion-table">

            <!-- Columna Tipo -->
<ng-container matColumnDef="tipo">
  <th mat-header-cell *matHeaderCellDef>Tipo</th>
  <td mat-cell *matCellDef="let detalle">
    <mat-chip [color]="getChipColor(detalle.tipo)" selected="true">
      <mat-icon>{{ getChipIcon(detalle.tipo) }}</mat-icon>
      {{ detalle.tipo | titlecase }}
    </mat-chip>
  </td>
</ng-container>

            <!-- Columna Concepto -->
<ng-container matColumnDef="concepto">
  <th mat-header-cell *matHeaderCellDef>Concepto</th>
  <td mat-cell *matCellDef="let detalle">
    <div class="concepto-cell">
      <strong [class.descuento]="detalle.total < 0">
        {{ getConceptoTexto(detalle) }}
        <span *ngIf="detalle.total < 0" class="descuento-label">(DESCUENTO)</span>
      </strong>
      
      <!-- Mostrar referencia y descripción para entradas/salidas individuales -->
      <div *ngIf="detalle.referencia && detalle.referencia !== 'STOCK_INICIAL' && detalle.referencia !== 'TRABAJO'" class="referencia">
        {{ detalle.referencia }} - {{ detalle.descripcion }}
      </div>
      
      <!-- NUEVO: Mostrar dirección para trabajos -->
      <div *ngIf="detalle.tipo === 'trabajo'" class="trabajo-direccion">
        <mat-icon class="icon-small">location_on</mat-icon>
        {{ detalle.descripcion }}
      </div>
      
      <!-- NUEVO: Mostrar observaciones para trabajos -->
      <div *ngIf="detalle.tipo === 'trabajo' && detalle.observaciones" class="trabajo-observaciones">
        <mat-icon class="icon-small">note</mat-icon>
        {{ detalle.observaciones }}
      </div>
      
      <!-- Información de días -->
      <div *ngIf="detalle.diasAlmacenaje && detalle.diasAlmacenaje !== 0" class="dias-almacenaje">
        <mat-icon>{{ detalle.diasAlmacenaje > 0 ? 'schedule' : 'remove_circle' }}</mat-icon>
        <span [class.descuento]="detalle.diasAlmacenaje < 0">
          {{ Math.abs(detalle.diasAlmacenaje) }} días
          {{ detalle.diasAlmacenaje < 0 ? 'descontados' : 'de almacenaje' }}
        </span>
      </div>
      
      <!-- Fecha de salida para descuentos -->
      <div *ngIf="detalle.fechaSalida && detalle.total < 0" class="fecha-salida">
        <mat-icon>logout</mat-icon>
        Salida: {{ detalle.fechaSalida | date:'dd/MM/yyyy' }}
      </div>
    </div>
  </td>
</ng-container>

            <!-- Columna Cantidad -->
            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let detalle">
                <span class="cantidad" [class.descuento]="detalle.cantidad < 0">
                  {{ detalle.cantidad }}
                </span>
              </td>
            </ng-container>

            <!-- Columna Precio -->
            <ng-container matColumnDef="precio">
              <th mat-header-cell *matHeaderCellDef>Precio Unit.</th>
              <td mat-cell *matCellDef="let detalle">
                {{ detalle.precio | currency:'EUR':'symbol':'1.2-2' }}
              </td>
            </ng-container>

            <!-- Columna Total -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let detalle">
                <span class="total-cell" [class.descuento]="detalle.total < 0">
                  {{ detalle.total | currency:'EUR':'symbol':'1.2-2' }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <!-- Mensaje si no hay datos -->
        <div *ngIf="resumenFacturacion.detalles.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No se encontraron movimientos ni almacenaje para el período seleccionado.</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- NUEVA SECCIÓN: Detalle de Trabajos de Manipulación -->
<mat-card class="trabajos-card" *ngIf="mostrarResultados && resumenFacturacion && getTotalTrabajos() > 0">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>build</mat-icon>
      Detalle de Trabajos de Manipulación
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <div class="trabajos-resumen">
      <div class="trabajo-item total-trabajos">
        <mat-icon>work</mat-icon>
        <div class="trabajo-info">
          <span class="label">Total de Trabajos</span>
          <span class="cantidad">{{ getDetallesTrabajos().length }}</span>
        </div>
      </div>

      <div class="trabajo-item total-horas">
        <mat-icon>schedule</mat-icon>
        <div class="trabajo-info">
          <span class="label">Total de Horas</span>
          <span class="cantidad">{{ getTotalHoras() }}</span>
        </div>
      </div>

      <div class="trabajo-item total-importe">
        <mat-icon>euro</mat-icon>
        <div class="trabajo-info">
          <span class="label">Total Importe</span>
          <span class="cantidad total-trabajos-amount">{{ getTotalTrabajos() | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Tabla de trabajos -->
    <div class="trabajos-tabla-container">
      <table class="trabajos-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Concepto</th>
            <th>Dirección</th>
            <th>Horas</th>
            <th>Precio/Hora</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let trabajo of getDetallesTrabajos()">
            <td>{{ trabajo.fechaEntrada | date:'dd/MM/yyyy' }}</td>
            <td>{{ trabajo.concepto }}</td>
            <td>{{ trabajo.descripcion }}</td>
            <td class="centrado">{{ trabajo.cantidad }}</td>
            <td class="centrado">{{ trabajo.precio | currency:'EUR':'symbol':'1.2-2' }}</td>
            <td class="centrado total-cell">{{ trabajo.total | currency:'EUR':'symbol':'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </mat-card-content>
</mat-card>

    <!-- Información de tarifas -->
    <mat-card class="tarifas-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          Tarifas Aplicadas
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="tarifas-grid">
          <div class="tarifa-item">
            <mat-icon>warehouse</mat-icon>
            <span>Almacenaje por palet/mes</span>
            <span class="precio">{{ TARIFA_PALET_MES | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>

          <div class="tarifa-item">
            <mat-icon>inventory</mat-icon>
            <span>Movimiento por palet</span>
            <span class="precio">{{ TARIFA_MOVIMIENTO_PALET | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>

          <div class="tarifa-item">
            <mat-icon>cases</mat-icon>
            <span>Movimiento por bulto</span>
            <span class="precio">{{ TARIFA_MOVIMIENTO_BULTO | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>

          <div class="tarifa-item">
            <mat-icon>confirmation_number</mat-icon>
            <span>Movimiento por unidad</span>
            <span class="precio">{{ TARIFA_MOVIMIENTO_UNIDAD | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="nota-tarifas">
          <mat-icon>info_outline</mat-icon>
          <p>
            <strong>Lógica de facturación:</strong>
            <br>• Los palets que ya estaban en el almacén al inicio del mes se facturan completos (mes entero).
            <br>• Los palets que entran durante el mes se facturan proporcionalmente desde su fecha de entrada.
            <br>• Los palets que salen durante el mes generan un descuento proporcional desde su fecha de salida.
            <br>• Los movimientos se cobran según la jerarquía: palets > bultos > unidades.
            <br>• La facturación siempre es del día 1 al último día del mes seleccionado.
          </p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>